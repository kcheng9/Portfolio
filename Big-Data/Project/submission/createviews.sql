DROP MATERIALIZED VIEW IF EXISTS final.all_patients;

CREATE MATERIALIZED VIEW final.all_patients AS 
 SELECT a.subject_id,
    a.label,
    a.index_date
   FROM (( SELECT p.subject_id,
            p.label,
            min(c.charttime) AS index_date
           FROM final.case_patients p
             JOIN mimiciii.chartevents c ON p.subject_id = c.subject_id
          WHERE (c.itemid = ANY (ARRAY[51, 442, 455, 6701, 220179, 220050])) AND c.valuenum < 90::double precision
          GROUP BY p.subject_id, p.label
          ORDER BY p.subject_id)
        UNION ALL
        ( SELECT p.subject_id,
            p.label,
            max(c.charttime) AS index_date
           FROM final.control_patients p
             JOIN mimiciii.chartevents c ON p.subject_id = c.subject_id
          GROUP BY p.subject_id, p.label
          ORDER BY p.subject_id)) a

DROP MATERIALIZED VIEW IF EXISTS final.case_patients;

CREATE MATERIALIZED VIEW final.case_patients AS 
 SELECT p.subject_id,
    1 AS label
   FROM final.filtered_cohort p
     JOIN mimiciii.diagnoses_icd d ON p.subject_id = d.subject_id
  WHERE d.icd9_code::text = ANY (ARRAY['67020'::character varying::text, '67022'::character varying::text, '67024'::character varying::text, '78552'::character varying::text, '99591'::character varying::text, '99592'::character varying::text])
  GROUP BY p.subject_id

DROP MATERIALIZED VIEW IF EXISTS final.control_patients;

CREATE MATERIALIZED VIEW final.control_patients AS 
 SELECT p.subject_id,
    0 AS label
   FROM final.filtered_cohort p
  WHERE NOT (p.subject_id IN ( SELECT c.subject_id
           FROM final.case_patients c))
  GROUP BY p.subject_id

DROP MATERIALIZED VIEW IF EXISTS final.filtered_chartevents;

CREATE MATERIALIZED VIEW final.filtered_chartevents AS 
 SELECT p.subject_id,
    c.itemid,
    c.charttime,
    c.valuenum
   FROM final.all_patients p
     JOIN mimiciii.chartevents c ON p.subject_id = c.subject_id
  WHERE c.charttime <= p.index_date AND c.valuenum IS NOT NULL AND (c.itemid = ANY (ARRAY[184, 220739, 454, 223901, 198, 723, 223900, 51, 442, 455, 6701, 220179, 211, 20045]))

DROP MATERIALIZED VIEW IF EXISTS final.filtered_cohort;

CREATE MATERIALIZED VIEW final.filtered_cohort AS 
 SELECT a.subject_id
   FROM mimiciii.admissions a
     LEFT JOIN mimiciii.patients p ON a.subject_id = p.subject_id
  WHERE floor(date_part('epoch'::text, a.admittime - p.dob) / 31536000::double precision) >= 15::double precision
  GROUP BY a.subject_id

DROP MATERIALIZED VIEW IF EXISTS final.filtered_diagnoses;

CREATE MATERIALIZED VIEW final.filtered_diagnoses AS 
 SELECT b.subject_id,
    ceiling(avg(b.label)) AS label
   FROM ( SELECT p.subject_id,
                CASE
                    WHEN d.icd9_code::text = ANY (ARRAY['25000'::character varying::text, '25001'::character varying::text, '25002'::character varying::text, '25003'::character varying::text, '25010'::character varying::text, '25011'::character varying::text, '25012'::character varying::text, '25013'::character varying::text, '25020'::character varying::text, '25021'::character varying::text, '25022'::character varying::text, '25023'::character varying::text, '25030'::character varying::text, '25031'::character varying::text, '25032'::character varying::text, '25033'::character varying::text, '25040'::character varying::text, '25041'::character varying::text, '25042'::character varying::text, '25043'::character varying::text, '25050'::character varying::text, '25051'::character varying::text, '25052'::character varying::text, '25053'::character varying::text, '25060'::character varying::text, '25061'::character varying::text, '25062'::character varying::text, '25063'::character varying::text, '25070'::character varying::text, '25071'::character varying::text, '25072'::character varying::text, '25073'::character varying::text, '25080'::character varying::text, '25081'::character varying::text, '25082'::character varying::text, '25083'::character varying::text, '25090'::character varying::text, '25092'::character varying::text, '25093'::character varying::text, '4280'::character varying::text, '4281'::character varying::text, '42820'::character varying::text, '42821'::character varying::text, '42822'::character varying::text, '42823'::character varying::text, '42830'::character varying::text, '42831'::character varying::text, '42832'::character varying::text, '42833'::character varying::text, '42840'::character varying::text, '42841'::character varying::text, '42842'::character varying::text, '42843'::character varying::text, '4289'::character varying::text, '20000'::character varying::text, '20001'::character varying::text, '20002'::character varying::text, '20003'::character varying::text, '20004'::character varying::text, '20005'::character varying::text, '20006'::character varying::text, '20007'::character varying::text, '20008'::character varying::text, '20010'::character varying::text, '20011'::character varying::text, '20012'::character varying::text, '20013'::character varying::text, '20014'::character varying::text, '20015'::character varying::text, '20016'::character varying::text, '20017'::character varying::text, '20018'::character varying::text, '20020'::character varying::text, '20021'::character varying::text, '20022'::character varying::text, '20023'::character varying::text, '20024'::character varying::text, '20025'::character varying::text, '20026'::character varying::text, '20027'::character varying::text, '20028'::character varying::text, '20030'::character varying::text, '20031'::character varying::text, '20032'::character varying::text, '20033'::character varying::text, '20034'::character varying::text, '20035'::character varying::text, '20036'::character varying::text, '20037'::character varying::text, '20038'::character varying::text, '20040'::character varying::text, '20041'::character varying::text, '20042'::character varying::text, '20043'::character varying::text, '20044'::character varying::text, '20045'::character varying::text, '20046'::character varying::text, '20047'::character varying::text, '20048'::character varying::text, '20050'::character varying::text, '20051'::character varying::text, '20052'::character varying::text, '20053'::character varying::text, '20054'::character varying::text, '20055'::character varying::text, '20056'::character varying::text, '20057'::character varying::text, '20058'::character varying::text, '20060'::character varying::text, '20061'::character varying::text, '20062'::character varying::text, '20063'::character varying::text, '20064'::character varying::text, '20065'::character varying::text, '20066'::character varying::text, '20067'::character varying::text, '20068'::character varying::text, '20070'::character varying::text, '20071'::character varying::text, '20072'::character varying::text, '20073'::character varying::text, '20074'::character varying::text, '20075'::character varying::text, '20076'::character varying::text, '20077'::character varying::text, '20078'::character varying::text, '20080'::character varying::text, '20081'::character varying::text, '20082'::character varying::text, '20083'::character varying::text, '20084'::character varying::text, '20085'::character varying::text, '20086'::character varying::text, '20087'::character varying::text, '20088'::character varying::text, '20100'::character varying::text, '20101'::character varying::text, '20102'::character varying::text, '20103'::character varying::text, '20104'::character varying::text, '20105'::character varying::text, '20106'::character varying::text, '20107'::character varying::text, '20108'::character varying::text, '20110'::character varying::text, '20111'::character varying::text, '20112'::character varying::text, '20113'::character varying::text, '20114'::character varying::text, '20115'::character varying::text, '20116'::character varying::text, '20117'::character varying::text, '20118'::character varying::text, '20120'::character varying::text, '20121'::character varying::text, '20122'::character varying::text, '20123'::character varying::text, '20124'::character varying::text, '20125'::character varying::text, '20126'::character varying::text, '20127'::character varying::text, '20128'::character varying::text, '20140'::character varying::text, '20141'::character varying::text, '20142'::character varying::text, '20143'::character varying::text, '20144'::character varying::text, '20145'::character varying::text, '20146'::character varying::text, '20147'::character varying::text, '20148'::character varying::text, '20150'::character varying::text, '20151'::character varying::text, '20152'::character varying::text, '20153'::character varying::text, '20154'::character varying::text, '20155'::character varying::text, '20156'::character varying::text, '20157'::character varying::text, '20158'::character varying::text, '20160'::character varying::text, '20161'::character varying::text, '20162'::character varying::text, '20163'::character varying::text, '20164'::character varying::text, '20165'::character varying::text, '20166'::character varying::text, '20167'::character varying::text, '20168'::character varying::text, '20170'::character varying::text, '20171'::character varying::text, '20172'::character varying::text, '20173'::character varying::text, '20174'::character varying::text, '20175'::character varying::text, '20176'::character varying::text, '20177'::character varying::text, '20178'::character varying::text, '20190'::character varying::text, '20191'::character varying::text, '20192'::character varying::text, '20193'::character varying::text, '20194'::character varying::text, '20195'::character varying::text, '20196'::character varying::text, '20197'::character varying::text, '20198'::character varying::text, '20200'::character varying::text, '20201'::character varying::text, '20202'::character varying::text, '20203'::character varying::text, '20204'::character varying::text, '20205'::character varying::text, '20206'::character varying::text, '20207'::character varying::text, '20208'::character varying::text, '20210'::character varying::text, '20211'::character varying::text, '20212'::character varying::text, '20213'::character varying::text, '20214'::character varying::text, '20215'::character varying::text, '20216'::character varying::text, '20217'::character varying::text, '20218'::character varying::text, '20220'::character varying::text, '20221'::character varying::text, '20222'::character varying::text, '20223'::character varying::text, '20224'::character varying::text, '20225'::character varying::text, '20226'::character varying::text, '20227'::character varying::text, '20228'::character varying::text, '20230'::character varying::text, '20231'::character varying::text, '20232'::character varying::text, '20233'::character varying::text, '20234'::character varying::text, '20235'::character varying::text, '20236'::character varying::text, '20237'::character varying::text, '20238'::character varying::text, '20240'::character varying::text, '20241'::character varying::text, '20242'::character varying::text, '20243'::character varying::text, '20244'::character varying::text, '20245'::character varying::text, '20246'::character varying::text, '20247'::character varying::text, '20248'::character varying::text, '20250'::character varying::text, '20251'::character varying::text, '20252'::character varying::text, '20253'::character varying::text, '20254'::character varying::text, '20255'::character varying::text, '20256'::character varying::text, '20257'::character varying::text, '20258'::character varying::text, '20260'::character varying::text, '20261'::character varying::text, '20262'::character varying::text, '20263'::character varying::text, '20264'::character varying::text, '20265'::character varying::text, '20266'::character varying::text, '20267'::character varying::text, '20268'::character varying::text, '20270'::character varying::text, '20271'::character varying::text, '20272'::character varying::text, '20273'::character varying::text, '20274'::character varying::text, '20275'::character varying::text, '20276'::character varying::text, '20277'::character varying::text, '20278'::character varying::text, '20280'::character varying::text, '20281'::character varying::text, '20282'::character varying::text, '20283'::character varying::text, '20284'::character varying::text, '20285'::character varying::text, '20286'::character varying::text, '20287'::character varying::text, '20288'::character varying::text, '20290'::character varying::text, '20291'::character varying::text, '20292'::character varying::text, '20293'::character varying::text, '20294'::character varying::text, '20295'::character varying::text, '20296'::character varying::text, '20297'::character varying::text, '20298'::character varying::text, '20300'::character varying::text, '20301'::character varying::text, '20302'::character varying::text, '20310'::character varying::text, '20311'::character varying::text, '20312'::character varying::text, '20380'::character varying::text, '20381'::character varying::text, '20382'::character varying::text, '20400'::character varying::text, '20401'::character varying::text, '20402'::character varying::text, '20410'::character varying::text, '20411'::character varying::text, '20412'::character varying::text, '20420'::character varying::text, '20421'::character varying::text, '20422'::character varying::text, '20480'::character varying::text, '20481'::character varying::text, '20482'::character varying::text, '20490'::character varying::text, '20491'::character varying::text, '20492'::character varying::text, '20500'::character varying::text, '20501'::character varying::text, '20502'::character varying::text, '20510'::character varying::text, '20511'::character varying::text, '20512'::character varying::text, '20520'::character varying::text, '20521'::character varying::text, '20522'::character varying::text, '20530'::character varying::text, '20531'::character varying::text, '20532'::character varying::text, '20580'::character varying::text, '20581'::character varying::text, '20582'::character varying::text, '20590'::character varying::text, '20591'::character varying::text, '20592'::character varying::text, '20600'::character varying::text, '20601'::character varying::text, '20602'::character varying::text, '20610'::character varying::text, '20611'::character varying::text, '20612'::character varying::text, '20620'::character varying::text, '20621'::character varying::text, '20622'::character varying::text, '20680'::character varying::text, '20681'::character varying::text, '20682'::character varying::text, '20690'::character varying::text, '20691'::character varying::text, '20692'::character varying::text, '20700'::character varying::text, '20701'::character varying::text, '20702'::character varying::text, '20710'::character varying::text, '20711'::character varying::text, '20712'::character varying::text, '20720'::character varying::text, '20721'::character varying::text, '20722'::character varying::text, '20780'::character varying::text, '20781'::character varying::text, '20782'::character varying::text, '20800'::character varying::text, '20801'::character varying::text, '20802'::character varying::text, '20810'::character varying::text, '20811'::character varying::text, '20812'::character varying::text, '20820'::character varying::text, '20821'::character varying::text, '20822'::character varying::text, '20880'::character varying::text, '20881'::character varying::text, '20882'::character varying::text, '20890'::character varying::text, '20891'::character varying::text, '20892'::character varying::text, '42'::character varying::text, 'V580'::character varying::text, 'V5811'::character varying::text, 'V5812'::character varying::text, 'V5865'::character varying::text, '20200'::character varying::text, '20201'::character varying::text, '20202'::character varying::text, '20203'::character varying::text, '20204'::character varying::text, '20205'::character varying::text, '20206'::character varying::text, '20207'::character varying::text, '20208'::character varying::text, '20210'::character varying::text, '20211'::character varying::text, '20212'::character varying::text, '20213'::character varying::text, '20214'::character varying::text, '20215'::character varying::text, '20216'::character varying::text, '20217'::character varying::text, '20218'::character varying::text, '20220'::character varying::text, '20221'::character varying::text, '20222'::character varying::text, '20223'::character varying::text, '20224'::character varying::text, '20225'::character varying::text, '20226'::character varying::text, '20227'::character varying::text, '20228'::character varying::text, '20230'::character varying::text, '20231'::character varying::text, '20232'::character varying::text, '20233'::character varying::text, '20234'::character varying::text, '20235'::character varying::text, '20236'::character varying::text, '20237'::character varying::text, '20238'::character varying::text, '20240'::character varying::text, '20241'::character varying::text, '20242'::character varying::text, '20243'::character varying::text, '20244'::character varying::text, '20245'::character varying::text, '20246'::character varying::text, '20247'::character varying::text, '20248'::character varying::text, '20250'::character varying::text, '20251'::character varying::text, '20252'::character varying::text, '20253'::character varying::text, '20254'::character varying::text, '20255'::character varying::text, '20256'::character varying::text, '20257'::character varying::text, '20258'::character varying::text, '20260'::character varying::text, '20261'::character varying::text, '20262'::character varying::text, '20263'::character varying::text, '20264'::character varying::text, '20265'::character varying::text, '20266'::character varying::text, '20267'::character varying::text, '20268'::character varying::text, '20270'::character varying::text, '20271'::character varying::text, '20272'::character varying::text, '20273'::character varying::text, '20274'::character varying::text, '20275'::character varying::text, '20276'::character varying::text, '20277'::character varying::text, '20278'::character varying::text, '20280'::character varying::text, '20281'::character varying::text, '20282'::character varying::text, '20283'::character varying::text, '20284'::character varying::text, '20285'::character varying::text, '20286'::character varying::text, '20287'::character varying::text, '20288'::character varying::text, '20290'::character varying::text, '20291'::character varying::text, '20292'::character varying::text, '20293'::character varying::text, '20294'::character varying::text, '20295'::character varying::text, '20296'::character varying::text, '20297'::character varying::text, '20298'::character varying::text, '20800'::character varying::text, '20801'::character varying::text, '20802'::character varying::text, '20810'::character varying::text, '20811'::character varying::text, '20812'::character varying::text, '20820'::character varying::text, '20821'::character varying::text, '20822'::character varying::text, '20880'::character varying::text, '20881'::character varying::text, '20882'::character varying::text, '20890'::character varying::text, '20891'::character varying::text, '20892'::character varying::text, '5710'::character varying::text, '5711'::character varying::text, '5712'::character varying::text, '5713'::character varying::text, '57140'::character varying::text, '57141'::character varying::text, '57142'::character varying::text, '57149'::character varying::text, '5715'::character varying::text, '5716'::character varying::text, '5718'::character varying::text, '5719'::character varying::text, '1400'::character varying::text, '1401'::character varying::text, '1403'::character varying::text, '1404'::character varying::text, '1405'::character varying::text, '1406'::character varying::text, '1408'::character varying::text, '1409'::character varying::text, '1410'::character varying::text, '1411'::character varying::text, '1412'::character varying::text, '1413'::character varying::text, '1414'::character varying::text, '1415'::character varying::text, '1416'::character varying::text, '1418'::character varying::text, '1419'::character varying::text, '1420'::character varying::text, '1421'::character varying::text, '1422'::character varying::text, '1428'::character varying::text, '1429'::character varying::text, '1430'::character varying::text, '1431'::character varying::text, '1438'::character varying::text, '1439'::character varying::text, '1440'::character varying::text, '1441'::character varying::text, '1448'::character varying::text, '1449'::character varying::text, '1450'::character varying::text, '1451'::character varying::text, '1452'::character varying::text, '1453'::character varying::text, '1454'::character varying::text, '1455'::character varying::text, '1456'::character varying::text, '1458'::character varying::text, '1459'::character varying::text, '1460'::character varying::text, '1461'::character varying::text, '1462'::character varying::text, '1463'::character varying::text, '1464'::character varying::text, '1465'::character varying::text, '1466'::character varying::text, '1467'::character varying::text, '1468'::character varying::text, '1469'::character varying::text, '1470'::character varying::text, '1472'::character varying::text, '1472'::character varying::text, '1473'::character varying::text, '1478'::character varying::text, '1479'::character varying::text, '1480'::character varying::text, '1481'::character varying::text, '1481'::character varying::text, '1482'::character varying::text, '1483'::character varying::text, '1488'::character varying::text, '1489'::character varying::text, '1490'::character varying::text, '1491'::character varying::text, '1498'::character varying::text, '1499'::character varying::text, '1500'::character varying::text, '1501'::character varying::text, '1502'::character varying::text, '1503'::character varying::text, '1504'::character varying::text, '1505'::character varying::text, '1508'::character varying::text, '1509'::character varying::text, '1510'::character varying::text, '1511'::character varying::text, '1512'::character varying::text, '1513'::character varying::text, '1514'::character varying::text, '1515'::character varying::text, '1516'::character varying::text, '1518'::character varying::text, '1519'::character varying::text, '1520'::character varying::text, '1521'::character varying::text, '1522'::character varying::text, '1523'::character varying::text, '1528'::character varying::text, '1529'::character varying::text, '1530'::character varying::text, '1531'::character varying::text, '1532'::character varying::text, '1533'::character varying::text, '1534'::character varying::text, '1535'::character varying::text, '1536'::character varying::text, '1537'::character varying::text, '1538'::character varying::text, '1539'::character varying::text, '1540'::character varying::text, '1541'::character varying::text, '1542'::character varying::text, '1543'::character varying::text, '1548'::character varying::text, '1550'::character varying::text, '1551'::character varying::text, '1552'::character varying::text, '1560'::character varying::text, '1561'::character varying::text, '1562'::character varying::text, '1568'::character varying::text, '1569'::character varying::text, '1570'::character varying::text, '1571'::character varying::text, '1572'::character varying::text, '1573'::character varying::text, '1574'::character varying::text, '1578'::character varying::text, '1579'::character varying::text, '1580'::character varying::text, '1588'::character varying::text, '1589'::character varying::text, '1590'::character varying::text, '1591'::character varying::text, '1598'::character varying::text, '1599'::character varying::text, '1600'::character varying::text, '1601'::character varying::text, '1602'::character varying::text, '1603'::character varying::text, '1604'::character varying::text, '1605'::character varying::text, '1608'::character varying::text, '1609'::character varying::text, '1610'::character varying::text, '1611'::character varying::text, '1612'::character varying::text, '1613'::character varying::text, '1618'::character varying::text, '1619'::character varying::text, '1620'::character varying::text, '1622'::character varying::text, '1623'::character varying::text, '1624'::character varying::text, '1625'::character varying::text, '1628'::character varying::text, '1629'::character varying::text, '1630'::character varying::text, '1631'::character varying::text, '1638'::character varying::text, '1639'::character varying::text, '1640'::character varying::text, '1641'::character varying::text, '1642'::character varying::text, '1643'::character varying::text, '1648'::character varying::text, '1649'::character varying::text, '1650'::character varying::text, '1658'::character varying::text, '1659'::character varying::text, '1700'::character varying::text, '1701'::character varying::text, '1702'::character varying::text, '1703'::character varying::text, '1704'::character varying::text, '1705'::character varying::text, '1706'::character varying::text, '1707'::character varying::text, '1708'::character varying::text, '1709'::character varying::text, '1710'::character varying::text, '1712'::character varying::text, '1713'::character varying::text, '1714'::character varying::text, '1715'::character varying::text, '1716'::character varying::text, '1717'::character varying::text, '1718'::character varying::text, '1719'::character varying::text, '1720'::character varying::text, '1721'::character varying::text, '1722'::character varying::text, '1723'::character varying::text, '1724'::character varying::text, '1725'::character varying::text, '1726'::character varying::text, '1727'::character varying::text, '1728'::character varying::text, '1729'::character varying::text, '17300'::character varying::text, '17301'::character varying::text, '17302'::character varying::text, '17309'::character varying::text, '17310'::character varying::text, '17311'::character varying::text, '17312'::character varying::text, '17319'::character varying::text, '17320'::character varying::text, '17321'::character varying::text, '17322'::character varying::text, '17329'::character varying::text, '17330'::character varying::text, '17331'::character varying::text, '17332'::character varying::text, '17339'::character varying::text, '17340'::character varying::text, '17341'::character varying::text, '17342'::character varying::text, '17349'::character varying::text, '17350'::character varying::text, '17351'::character varying::text, '17352'::character varying::text, '17359'::character varying::text, '17360'::character varying::text, '17361'::character varying::text, '17362'::character varying::text, '17369'::character varying::text, '17370'::character varying::text, '17371'::character varying::text, '17372'::character varying::text, '17379'::character varying::text, '17380'::character varying::text, '17381'::character varying::text, '17382'::character varying::text, '17389'::character varying::text, '17390'::character varying::text, '17391'::character varying::text, '17392'::character varying::text, '17399'::character varying::text, '1740'::character varying::text, '1741'::character varying::text, '1742'::character varying::text, '1743'::character varying::text, '1744'::character varying::text, '1745'::character varying::text, '1746'::character varying::text, '1748'::character varying::text, '1749'::character varying::text, '1750'::character varying::text, '1759'::character varying::text, '179'::character varying::text, '1800'::character varying::text, '1801'::character varying::text, '1808'::character varying::text, '1809'::character varying::text, '181'::character varying::text, '1820'::character varying::text, '1821'::character varying::text, '1828'::character varying::text, '1830'::character varying::text, '1832'::character varying::text, '1833'::character varying::text, '1834'::character varying::text, '1835'::character varying::text, '1838'::character varying::text, '1839'::character varying::text, '1840'::character varying::text, '1841'::character varying::text, '1842'::character varying::text, '1843'::character varying::text, '1844'::character varying::text, '1848'::character varying::text, '1849'::character varying::text, '185'::character varying::text, '1860'::character varying::text, '1869'::character varying::text, '1871'::character varying::text, '1872'::character varying::text, '1873'::character varying::text, '1874'::character varying::text, '1875'::character varying::text, '1876'::character varying::text, '1877'::character varying::text, '1878'::character varying::text, '1879'::character varying::text, '1880'::character varying::text, '1881'::character varying::text, '1882'::character varying::text, '1883'::character varying::text, '1884'::character varying::text, '1885'::character varying::text, '1886'::character varying::text, '1887'::character varying::text, '1888'::character varying::text, '1889'::character varying::text, '1890'::character varying::text, '1891'::character varying::text, '1892'::character varying::text, '1893'::character varying::text, '1894'::character varying::text, '1898'::character varying::text, '1899'::character varying::text, '1900'::character varying::text, '1901'::character varying::text, '1902'::character varying::text, '1903'::character varying::text, '1904'::character varying::text, '1905'::character varying::text, '1906'::character varying::text, '1907'::character varying::text, '1908'::character varying::text, '1909'::character varying::text, '1910'::character varying::text, '1911'::character varying::text, '1912'::character varying::text, '1913'::character varying::text, '1914'::character varying::text, '1915'::character varying::text, '1916'::character varying::text, '1917'::character varying::text, '1918'::character varying::text, '1919'::character varying::text, '1920'::character varying::text, '1921'::character varying::text, '1922'::character varying::text, '1923'::character varying::text, '1928'::character varying::text, '1929'::character varying::text, '1931940'::character varying::text, '1941'::character varying::text, '1943'::character varying::text, '1944'::character varying::text, '1945'::character varying::text, '1946'::character varying::text, '1948'::character varying::text, '1949'::character varying::text, '1950'::character varying::text, '1951'::character varying::text, '1952'::character varying::text, '1953'::character varying::text, '1954'::character varying::text, '1955'::character varying::text, '1958'::character varying::text, '1960'::character varying::text, '1961'::character varying::text, '1962'::character varying::text, '1963'::character varying::text, '1965'::character varying::text, '1966'::character varying::text, '1968'::character varying::text, '1969'::character varying::text, '1970'::character varying::text, '1971'::character varying::text, '1972'::character varying::text, '1973'::character varying::text, '1974'::character varying::text, '1975'::character varying::text, '1976'::character varying::text, '1977'::character varying::text, '1978'::character varying::text, '1980'::character varying::text, '1981'::character varying::text, '1982'::character varying::text, '1983'::character varying::text, '1984'::character varying::text, '1985'::character varying::text, '1986'::character varying::text, '1987'::character varying::text, '19881'::character varying::text, '19882'::character varying::text, '19889'::character varying::text, '1990'::character varying::text, '1991'::character varying::text, '1992'::character varying::text, '5856'::character varying::text, '5719'::character varying::text, '5718'::character varying::text, '5716'::character varying::text, '5715'::character varying::text, '57149'::character varying::text, '57142'::character varying::text, '57141'::character varying::text, '57140'::character varying::text, '5713'::character varying::text, '5712'::character varying::text, '5711'::character varying::text, '5710'::character varying::text, '51883'::character varying::text, '42842'::character varying::text, '42832'::character varying::text, '42822'::character varying::text, '5859'::character varying::text, 'V4511'::character varying::text]) THEN 1
                    ELSE 0
                END AS label
           FROM final.all_patients p
             JOIN mimiciii.diagnoses_icd d ON p.subject_id = d.subject_id) b
  GROUP BY b.subject_id
  ORDER BY b.subject_id

DROP MATERIALIZED VIEW IF EXISTS final.filtered_inputevents_mv;

CREATE MATERIALIZED VIEW final.filtered_inputevents_mv AS 
 SELECT p.subject_id,
    i.starttime,
    i.endtime,
    i.itemid,
    i.amount,
    i.rate,
    i.patientweight,
    i.totalamount
   FROM final.all_patients p
     LEFT JOIN mimiciii.inputevents_mv i ON p.subject_id = i.subject_id
  WHERE i.starttime <= p.index_date AND (i.itemid = ANY (ARRAY[4478, 7853, 220949, 225158, 225798, 225837, 225838, 225840, 225842, 225843, 225844, 225845, 225847, 225848, 225850, 225851, 225853, 225855, 225859, 225860, 225862, 225863, 225865, 225866, 225868, 225869, 225871, 225873, 225875, 225876, 225877, 225879, 225881, 225883, 225884, 225885, 225886, 225888, 225889, 225890, 225892, 225893, 225895, 225896, 225898, 225899, 225902, 225903, 225905, 225943, 225944, 227691, 228003]))

DROP MATERIALIZED VIEW IF EXISTS final.filtered_labevents;

CREATE MATERIALIZED VIEW final.filtered_labevents AS 
 SELECT p.subject_id,
    f.itemid,
    f.charttime,
    f.valuenum
   FROM final.all_patients p
     LEFT JOIN mimiciii.labevents f ON p.subject_id = f.subject_id
  WHERE f.charttime <= p.index_date AND (f.itemid = ANY (ARRAY[51006, 50912]))